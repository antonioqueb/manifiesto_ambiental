<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Acci√≥n para Manifiesto Ambiental -->
    <record id="action_manifiesto_ambiental" model="ir.actions.act_window">
        <field name="name">Manifiestos Ambientales</field>
        <field name="res_model">manifiesto.ambiental</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('is_current_version', '=', True)]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear su primer Manifiesto Ambiental
            </p>
            <p>
                Los manifiestos ambientales son documentos oficiales para el control
                de residuos peligrosos durante su transporte y disposici√≥n final.
            </p>
        </field>
    </record>

    <!-- Acci√≥n para Historial de Versiones -->
    <record id="action_manifiesto_ambiental_version" model="ir.actions.act_window">
        <field name="name">Historial de Versiones</field>
        <field name="res_model">manifiesto.ambiental.version</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay versiones guardadas
            </p>
            <p>
                Aqu√≠ se mostrar√° el historial de todas las versiones de los manifiestos.
            </p>
        </field>
    </record>

    <!-- Acci√≥n para todas las versiones -->
    <record id="action_manifiesto_ambiental_all_versions" model="ir.actions.act_window">
        <field name="name">Todas las Versiones de Manifiestos</field>
        <field name="res_model">manifiesto.ambiental</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay manifiestos creados
            </p>
            <p>
                Aqu√≠ se muestran todas las versiones de todos los manifiestos,
                incluyendo versiones hist√≥ricas y actuales.
            </p>
        </field>
    </record>

    <!-- Lista de manifiesto.ambiental -->
    <record id="view_manifiesto_ambiental_list" model="ir.ui.view">
        <field name="name">manifiesto.ambiental.list</field>
        <field name="model">manifiesto.ambiental</field>
        <field name="type">list</field>
        <field name="arch" type="xml">
            <list string="Manifiestos Ambientales" default_order="numero_manifiesto desc, version desc">
                <field name="numero_manifiesto_display"/>
                <field name="numero_registro_ambiental"/>
                <field name="generador_nombre"/>
                <field name="transportista_nombre"/>
                <field name="destinatario_nombre"/>
                <field name="version" string="Ver."/>
                <field name="is_current_version" string="Actual" widget="boolean_toggle"/>
                <field name="tiene_documento_fisico" string="Doc. F√≠sico" widget="boolean_toggle"/>
                <field name="generador_fecha"/>
                <field name="state" decoration-success="state == 'delivered'" decoration-info="state == 'confirmed'" decoration-warning="state == 'in_transit'"/>
            </list>
        </field>
    </record>

    <!-- Formulario de manifiesto.ambiental -->
    <record id="view_manifiesto_ambiental_form" model="ir.ui.view">
        <field name="name">manifiesto.ambiental.form</field>
        <field name="model">manifiesto.ambiental</field>
        <field name="type">form</field>
        <field name="arch" type="xml">
            <form string="Manifiesto Ambiental">
                <header>
                    <!-- Botones de estado -->
                    <button name="action_confirm"
                            string="Confirmar"
                            type="object"
                            class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_in_transit"
                            string="En Tr√°nsito"
                            type="object"
                            class="btn-warning"
                            invisible="state != 'confirmed'"/>
                    <button name="action_delivered"
                            string="Entregado"
                            type="object"
                            class="btn-success"
                            invisible="state != 'in_transit'"/>
                    <button name="action_cancel"
                            string="Cancelar"
                            type="object"
                            invisible="state not in ['draft','confirmed','in_transit']"/>
                    
                    <!-- Botones de Remanifestaci√≥n - CORREGIDOS -->
                    <button name="action_remanifestar"
                            string="üîÑ Remanifestar (PDF)"
                            type="object"
                            class="btn-info"
                            invisible="not is_current_version or state == 'draft'"
                            confirm="¬øEst√° seguro de que desea crear una nueva versi√≥n? Se guardar√° un PDF de la versi√≥n actual."/>
                    
                    <button name="action_remanifestar_sin_pdf"
                            string="üîÑ Remanifestar (Datos)"
                            type="object"
                            class="btn-secondary"
                            invisible="not is_current_version or state == 'draft'"
                            confirm="¬øEst√° seguro de que desea crear una nueva versi√≥n? Se guardar√°n los datos estructurados de la versi√≥n actual."/>
                    
                    <!-- Botones de navegaci√≥n de versiones -->
                    <button name="action_view_version_history"
                            string="üìã Historial"
                            type="object"
                            class="btn-secondary"/>
                    <button name="action_view_current_version"
                            string="üéØ Ver Actual"
                            type="object"
                            class="btn-secondary"
                            invisible="is_current_version"/>
                    <button name="action_view_all_versions"
                            string="üìä Todas las Versiones"
                            type="object"
                            class="btn-secondary"/>
                    
                    <field name="state"
                           widget="statusbar"
                           statusbar_visible="draft,confirmed,in_transit,delivered"/>
                </header>
                <sheet>
                    <!-- Informaci√≥n de Versi√≥n (destacada) -->
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_version_history"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-history">
                            <field name="version" widget="statinfo" string="Versi√≥n"/>
                        </button>
                        <button name="action_view_all_versions"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-files-o">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Todas las Versiones</span>
                            </div>
                        </button>
                        <!-- BOT√ìN CORREGIDO: Solo mostrar estado del documento f√≠sico -->
                        <div class="oe_stat_button" style="pointer-events: none;">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value">
                                    <field name="tiene_documento_fisico" widget="boolean"/>
                                </span>
                                <span class="o_stat_text">Doc. F√≠sico</span>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de versi√≥n no actual -->
                    <div class="alert alert-warning" 
                         style="margin-bottom: 20px;" 
                         invisible="is_current_version">
                        <strong>‚ö†Ô∏è ATENCI√ìN:</strong> Esta no es la versi√≥n actual del manifiesto. 
                        <button name="action_view_current_version" 
                                type="object" 
                                class="btn btn-link p-0"
                                style="text-decoration: underline;">
                            Ir a la versi√≥n actual ‚Üí
                        </button>
                    </div>

                    <!-- Alerta de versi√≥n actual -->
                    <div class="alert alert-success" 
                         style="margin-bottom: 20px;" 
                         invisible="not is_current_version">
                        <strong>‚úÖ VERSI√ìN ACTUAL:</strong> Esta es la versi√≥n m√°s reciente del manifiesto.
                    </div>

                    <!-- Informaci√≥n B√°sica (1-3) -->
                    <div class="oe_title">
                        <h1>
                            <field name="numero_manifiesto_display" readonly="1"/>
                        </h1>
                        <h3 style="color: #6c757d;">
                            <span invisible="version &lt;= 1">Versi√≥n </span>
                            <field name="version" invisible="version &lt;= 1" readonly="1"/>
                            <span invisible="not is_current_version or version &lt;= 1"> (Actual)</span>
                        </h3>
                    </div>
                    
                    <group string="Informaci√≥n B√°sica" col="4">
                        <field name="numero_registro_ambiental"/>
                        <field name="pagina"/>
                        <field name="service_order_id" readonly="1"/>
                        <field name="company_id" groups="base.group_multi_company"/>
                    </group>

                    <!-- Campos de control de versiones (solo para versiones no iniciales) -->
                    <group string="Control de Versiones" 
                           invisible="version &lt;= 1" 
                           col="2">
                        <field name="original_manifiesto_id" readonly="1"/>
                        <field name="created_by_remanifest" readonly="1"/>
                        <field name="change_reason" 
                               placeholder="Ingrese el motivo de esta remanifestaci√≥n..."
                               invisible="not is_current_version"/>
                    </group>

                    <notebook>
                        <!-- Pesta√±a: Generador (4) -->
                        <page string="4. Generador">
                            <group string="Seleccionar Generador" col="1">
                                <field name="generador_id" 
                                       placeholder="Seleccione un generador..."
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       readonly="not is_current_version"/>
                            </group>
                            <group string="Datos del Generador" col="2">
                                <group>
                                    <field name="generador_nombre" readonly="not is_current_version"/>
                                    <field name="generador_calle" readonly="not is_current_version"/>
                                    <field name="generador_num_ext" readonly="not is_current_version"/>
                                    <field name="generador_num_int" readonly="not is_current_version"/>
                                    <field name="generador_colonia" readonly="not is_current_version"/>
                                </group>
                                <group>
                                    <field name="generador_municipio" readonly="not is_current_version"/>
                                    <field name="generador_estado" readonly="not is_current_version"/>
                                    <field name="generador_codigo_postal" readonly="not is_current_version"/>
                                    <field name="generador_telefono" readonly="not is_current_version"/>
                                    <field name="generador_email" readonly="not is_current_version"/>
                                </group>
                            </group>
                        </page>

                        <!-- Pesta√±a: Identificaci√≥n de Residuos (5) -->
                        <page string="5. Identificaci√≥n de Residuos">
                            <div class="alert alert-info" 
                                 style="margin-bottom: 15px;"
                                 invisible="not is_current_version">
                                <strong>üìã Instrucciones:</strong>
                                <ul style="margin: 5px 0;">
                                    <li>Seleccione productos del cat√°logo (preferiblemente residuos peligrosos)</li>
                                    <li>Las clasificaciones CRETIB se completar√°n autom√°ticamente si el producto est√° configurado</li>
                                    <li>La unidad siempre ser√° en kilogramos (kg)</li>
                                    <li>Los lotes se generar√°n autom√°ticamente con el n√∫mero de manifiesto</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-warning" 
                                 style="margin-bottom: 15px;"
                                 invisible="is_current_version">
                                <strong>üëÅÔ∏è SOLO LECTURA:</strong> Esta es una versi√≥n hist√≥rica del manifiesto. 
                                Para editar residuos, vaya a la versi√≥n actual.
                            </div>
                            
                            <field name="residuo_ids" readonly="not is_current_version">
                                <list editable="bottom" edit="is_current_version">
                                    <field name="product_id" 
                                           placeholder="Seleccionar producto/residuo..."
                                           options="{'no_create': True, 'no_create_edit': True}"/>
                                    <field name="nombre_residuo"/>
                                    <field name="clasificacion_corrosivo" string="C"/>
                                    <field name="clasificacion_reactivo" string="R"/>
                                    <field name="clasificacion_explosivo" string="E"/>
                                    <field name="clasificacion_toxico" string="T"/>
                                    <field name="clasificacion_inflamable" string="I"/>
                                    <field name="clasificacion_biologico" string="B"/>
                                    <field name="clasificaciones_display" string="CRETIB"/>
                                    <field name="envase_tipo"/>
                                    <field name="envase_capacidad"/>
                                    <field name="cantidad"/>
                                    <field name="unidad" readonly="1"/>
                                    <field name="etiqueta_si"/>
                                    <field name="etiqueta_no"/>
                                    <field name="lot_id" readonly="1"/>
                                </list>
                                <form string="Residuo">
                                    <sheet>
                                        <group string="Producto/Residuo" col="2">
                                            <field name="product_id" 
                                                   placeholder="Seleccionar producto/residuo..."
                                                   options="{'no_create': True, 'no_create_edit': True}"/>
                                            <field name="nombre_residuo"/>
                                        </group>
                                        
                                        <group string="Clasificaci√≥n CRETIB" col="3">
                                            <field name="clasificacion_corrosivo"/>
                                            <field name="clasificacion_reactivo"/>
                                            <field name="clasificacion_explosivo"/>
                                            <field name="clasificacion_toxico"/>
                                            <field name="clasificacion_inflamable"/>
                                            <field name="clasificacion_biologico"/>
                                        </group>
                                        
                                        <group string="Informaci√≥n del Envase" col="2">
                                            <field name="envase_tipo"/>
                                            <field name="envase_capacidad"/>
                                        </group>
                                        
                                        <group string="Cantidad y Etiquetado" col="2">
                                            <field name="cantidad"/>
                                            <field name="unidad" readonly="1"/>
                                            <field name="etiqueta_si"/>
                                            <field name="etiqueta_no"/>
                                        </group>
                                        
                                        <group string="Trazabilidad" col="1">
                                            <field name="lot_id" readonly="1"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>

                        <!-- Pesta√±a: Documento F√≠sico Escaneado -->
                        <page string="üìÑ Documento F√≠sico" name="documento_fisico">
                            <div class="alert alert-info" style="margin-bottom: 15px;">
                                <strong>üìã Documento F√≠sico Escaneado:</strong>
                                <p style="margin: 5px 0;">
                                    Suba aqu√≠ el manifiesto f√≠sico escaneado (papel con firmas originales, sellos, 
                                    modificaciones manuales, anotaciones, etc.) si se imprimi√≥ y proces√≥ en f√≠sico.
                                </p>
                                <ul style="margin: 5px 0;">
                                    <li>Cada versi√≥n puede tener su propio documento f√≠sico</li>
                                    <li>Al remanifestar, el documento f√≠sico anterior se guarda en el historial</li>
                                    <li>La nueva versi√≥n inicia sin documento f√≠sico para subir uno nuevo</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-warning" 
                                style="margin-bottom: 15px;"
                                invisible="is_current_version">
                                <strong>üëÅÔ∏è SOLO LECTURA:</strong> Esta es una versi√≥n hist√≥rica. 
                                Para subir nuevos documentos, vaya a la versi√≥n actual.
                            </div>
                            
                            <!-- Informaci√≥n del archivo y estado -->
                            <group string="Informaci√≥n del Documento" col="3">
                                <field name="documento_fisico_filename" readonly="not is_current_version"/>
                                <field name="tiene_documento_fisico" readonly="1"/>
                                <div invisible="not tiene_documento_fisico" 
                                    style="color: #28a745; font-weight: bold;">
                                    ‚úÖ Documento f√≠sico disponible
                                </div>
                                <div invisible="tiene_documento_fisico" 
                                    style="color: #6c757d; font-style: italic;">
                                    üìù Sin documento f√≠sico
                                </div>
                            </group>
                            
                            <!-- Visor de PDF con altura fija -->
                            <group string="Documento F√≠sico Escaneado" col="1">
                                <div style="width: 100%; height: 600px; border: 1px solid #ddd; background: #f9f9f9;">
                                    <field name="documento_fisico" 
                                        filename="documento_fisico_filename"
                                        readonly="not is_current_version"
                                        widget="pdf_viewer"
                                        style="width: 100%; height: 580px;"
                                        options="{'accepted_file_extensions': '.pdf,.png,.jpg,.jpeg,.gif,.bmp,.tiff', 'no_download': false}"/>
                                </div>
                            </group>
                        </page>

                        <!-- Pesta√±a: Instrucciones Especiales (6) -->
                        <page string="6. Instrucciones Especiales">
                            <group>
                                <field name="instrucciones_especiales" 
                                       nolabel="1" 
                                       placeholder="Instrucciones especiales e informaci√≥n adicional para el manejo seguro"
                                       readonly="not is_current_version"/>
                            </group>
                        </page>

                        <!-- Pesta√±a: Declaraci√≥n del Generador (7) -->
                        <page string="7. Declaraci√≥n Generador">
                            <group>
                                <field name="declaracion_generador" nolabel="1" readonly="1"/>
                            </group>
                            <group string="Firma y Sello" col="3">
                                <field name="generador_responsable_nombre" readonly="not is_current_version"/>
                                <field name="generador_fecha" readonly="not is_current_version"/>
                                <field name="generador_sello" readonly="not is_current_version"/>
                            </group>
                        </page>

                        <!-- Pesta√±a: Transportista (8-14) -->
                        <page string="8-14. Transportista">
                            <group string="Seleccionar Transportista" col="1">
                                <field name="transportista_id" 
                                       placeholder="Seleccione un transportista..."
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       readonly="not is_current_version"/>
                            </group>
                            <group string="8. Datos del Transportista" col="2">
                                <group>
                                    <field name="transportista_nombre" readonly="not is_current_version"/>
                                    <field name="transportista_calle" readonly="not is_current_version"/>
                                    <field name="transportista_num_ext" readonly="not is_current_version"/>
                                    <field name="transportista_num_int" readonly="not is_current_version"/>
                                    <field name="transportista_colonia" readonly="not is_current_version"/>
                                    <field name="transportista_municipio" readonly="not is_current_version"/>
                                </group>
                                <group>
                                    <field name="transportista_estado" readonly="not is_current_version"/>
                                    <field name="transportista_codigo_postal" readonly="not is_current_version"/>
                                    <field name="transportista_telefono" readonly="not is_current_version"/>
                                    <field name="transportista_email" readonly="not is_current_version"/>
                                </group>
                            </group>
                            
                            <group string="9-12. Informaci√≥n del Transporte" col="2">
                                <group>
                                    <field name="numero_autorizacion_semarnat" readonly="not is_current_version"/>
                                    <field name="numero_permiso_sct" readonly="not is_current_version"/>
                                </group>
                                <group>
                                    <field name="tipo_vehiculo" readonly="not is_current_version"/>
                                    <field name="numero_placa" readonly="not is_current_version"/>
                                </group>
                            </group>
                            
                            <group string="13. Ruta">
                                <field name="ruta_empresa" 
                                       nolabel="1" 
                                       placeholder="Ruta de la empresa generadora hasta su entrega"
                                       readonly="not is_current_version"/>
                            </group>

                            <group string="14. Declaraci√≥n del Transportista">
                                <field name="declaracion_transportista" nolabel="1" readonly="1"/>
                            </group>
                            <group string="Firma y Sello" col="3">
                                <field name="transportista_responsable_nombre" readonly="not is_current_version"/>
                                <field name="transportista_fecha" readonly="not is_current_version"/>
                                <field name="transportista_sello" readonly="not is_current_version"/>
                            </group>
                        </page>

                        <!-- Pesta√±a: Destinatario (15-19) -->
                        <page string="15-19. Destinatario">
                            <group string="Seleccionar Destinatario" col="1">
                                <field name="destinatario_id" 
                                       placeholder="Seleccione un destinatario..."
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       readonly="not is_current_version"/>
                            </group>
                            <group string="15. Datos del Destinatario" col="2">
                                <group>
                                    <field name="destinatario_nombre" readonly="not is_current_version"/>
                                    <field name="destinatario_calle" readonly="not is_current_version"/>
                                    <field name="destinatario_num_ext" readonly="not is_current_version"/>
                                    <field name="destinatario_num_int" readonly="not is_current_version"/>
                                    <field name="destinatario_colonia" readonly="not is_current_version"/>
                                </group>
                                <group>
                                    <field name="destinatario_municipio" readonly="not is_current_version"/>
                                    <field name="destinatario_estado" readonly="not is_current_version"/>
                                    <field name="destinatario_codigo_postal" readonly="not is_current_version"/>
                                    <field name="destinatario_telefono" readonly="not is_current_version"/>
                                    <field name="destinatario_email" readonly="not is_current_version"/>
                                </group>
                            </group>
                            
                            <group string="16-18. Informaci√≥n Adicional" col="2">
                                <group>
                                    <field name="numero_autorizacion_semarnat_destinatario" readonly="not is_current_version"/>
                                    <field name="nombre_persona_recibe" readonly="not is_current_version"/>
                                </group>
                                <group>
                                    <field name="observaciones_destinatario" 
                                           placeholder="Observaciones"
                                           readonly="not is_current_version"/>
                                </group>
                            </group>

                            <group string="19. Declaraci√≥n del Destinatario">
                                <field name="declaracion_destinatario" nolabel="1" readonly="1"/>
                            </group>
                            <group string="Firma y Sello" col="3">
                                <field name="destinatario_responsable_nombre" readonly="not is_current_version"/>
                                <field name="destinatario_fecha" readonly="not is_current_version"/>
                                <field name="destinatario_sello" readonly="not is_current_version"/>
                            </group>
                        </page>

                        <!-- Pesta√±a: Historial de Versiones -->
                        <page string="üìã Historial de Versiones" invisible="version &lt;= 1">
                            <div class="alert alert-info" style="margin-bottom: 15px;">
                                <strong>üîç Control de Versiones:</strong> 
                                Aqu√≠ puede ver todas las versiones guardadas de este manifiesto.
                                Cada versi√≥n incluye un archivo de respaldo (PDF o datos estructurados) y 
                                el documento f√≠sico si se subi√≥.
                            </div>
                            
                            <field name="version_history_ids" readonly="1">
                                <list string="Historial de Versiones">
                                    <field name="version_number"/>
                                    <field name="creation_date"/>
                                    <field name="created_by"/>
                                    <field name="state_at_creation"/>
                                    <field name="tenia_documento_fisico" string="Doc. F√≠sico"/>
                                    <field name="change_reason"/>
                                    <field name="pdf_filename"/>
                                    <button name="action_download_file" 
                                            type="object" 
                                            string="üìÑ PDF" 
                                            class="btn-link"/>
                                    <button name="action_view_file" 
                                            type="object" 
                                            string="üëÅÔ∏è Ver PDF" 
                                            class="btn-link"/>
                                    <button name="action_download_documento_fisico" 
                                            type="object" 
                                            string="üìé Doc. F√≠sico" 
                                            class="btn-link"
                                            invisible="not tenia_documento_fisico"/>
                                    <button name="action_view_documento_fisico" 
                                            type="object" 
                                            string="üëÅÔ∏è Ver Doc." 
                                            class="btn-link"
                                            invisible="not tenia_documento_fisico"/>
                                </list>
                            </field>
                        </page>
                    </notebook>

                    <!-- Campos ocultos para control -->
                    <group invisible="1">
                        <field name="is_current_version"/>
                        <field name="original_manifiesto_id"/>
                        <field name="created_by_remanifest"/>
                        <field name="tiene_documento_fisico"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de b√∫squeda -->
    <record id="view_manifiesto_ambiental_search" model="ir.ui.view">
        <field name="name">manifiesto.ambiental.search</field>
        <field name="model">manifiesto.ambiental</field>
        <field name="arch" type="xml">
            <search string="Buscar Manifiestos">
                <field name="numero_manifiesto"/>
                <field name="numero_registro_ambiental"/>
                <field name="generador_nombre"/>
                <field name="transportista_nombre"/>
                <field name="destinatario_nombre"/>
                <field name="version"/>
                <field name="change_reason"/>
                
                <!-- Filtros espec√≠ficos de versiones -->
                <filter string="Solo Versiones Actuales" name="current_versions" domain="[('is_current_version','=',True)]"/>
                <filter string="Solo Versiones Hist√≥ricas" name="historical_versions" domain="[('is_current_version','=',False)]"/>
                <filter string="Remanifestaciones" name="remanifested" domain="[('version','>',1)]"/>
                <filter string="Con Documento F√≠sico" name="with_physical_doc" domain="[('tiene_documento_fisico','=',True)]"/>
                <filter string="Sin Documento F√≠sico" name="without_physical_doc" domain="[('tiene_documento_fisico','=',False)]"/>
                
                <!-- Filtros de estado -->
                <filter string="Borrador" name="draft" domain="[('state','=','draft')]"/>
                <filter string="Confirmado" name="confirmed" domain="[('state','=','confirmed')]"/>
                <filter string="En Tr√°nsito" name="in_transit" domain="[('state','=','in_transit')]"/>
                <filter string="Entregado" name="delivered" domain="[('state','=','delivered')]"/>
                
                    <filter string="Estado" name="group_state" context="{'group_by':'state'}"/>
                    <filter string="Generador" name="group_generator" context="{'group_by':'generador_nombre'}"/>
                    <filter string="N√∫mero de Manifiesto" name="group_number" context="{'group_by':'numero_manifiesto'}"/>
                    <filter string="Versi√≥n" name="group_version" context="{'group_by':'version'}"/>
                    <filter string="Tiene Doc. F√≠sico" name="group_physical_doc" context="{'group_by':'tiene_documento_fisico'}"/>
                    <filter string="Fecha" name="group_date" context="{'group_by':'generador_fecha'}"/>
            </search>
        </field>
    </record>

    <!-- Vista de Lista para Historial de Versiones -->
    <record id="view_manifiesto_ambiental_version_list" model="ir.ui.view">
        <field name="name">manifiesto.ambiental.version.list</field>
        <field name="model">manifiesto.ambiental.version</field>
        <field name="arch" type="xml">
            <list string="Historial de Versiones" default_order="creation_date desc">
                <field name="manifiesto_id"/>
                <field name="version_number"/>
                <field name="creation_date"/>
                <field name="created_by"/>
                <field name="state_at_creation"/>
                <field name="tenia_documento_fisico" string="Doc. F√≠sico" widget="boolean_toggle"/>
                <field name="generador_nombre"/>
                <field name="transportista_nombre"/>
                <field name="destinatario_nombre"/>
                <field name="total_residuos"/>
                <field name="change_reason"/>
                <button name="action_download_file" 
                        type="object" 
                        string="üìÑ PDF" 
                        class="btn-link"/>
                <button name="action_view_file" 
                        type="object" 
                        string="üëÅÔ∏è Ver PDF" 
                        class="btn-link"/>
                <button name="action_download_documento_fisico" 
                        type="object" 
                        string="üìé Doc. F√≠sico" 
                        class="btn-link"
                        invisible="not tenia_documento_fisico"/>
                <button name="action_view_documento_fisico" 
                        type="object" 
                        string="üëÅÔ∏è Ver Doc." 
                        class="btn-link"
                        invisible="not tenia_documento_fisico"/>
            </list>
        </field>
    </record>

    <!-- Vista de Formulario para Historial de Versiones -->
    <record id="view_manifiesto_ambiental_version_form" model="ir.ui.view">
        <field name="name">manifiesto.ambiental.version.form</field>
        <field name="model">manifiesto.ambiental.version</field>
        <field name="arch" type="xml">
            <form string="Versi√≥n del Manifiesto" create="false" edit="false">
                <header>
                    <button name="action_download_file" 
                            string="üìÑ Descargar PDF/Datos" 
                            type="object" 
                            class="btn-primary"/>
                    <button name="action_view_file" 
                            string="üëÅÔ∏è Ver PDF/Datos" 
                            type="object" 
                            class="btn-secondary"/>
                    <button name="action_download_documento_fisico" 
                            string="üìé Descargar Doc. F√≠sico" 
                            type="object" 
                            class="btn-success"
                            invisible="not tenia_documento_fisico"/>
                    <button name="action_view_documento_fisico" 
                            string="üëÅÔ∏è Ver Doc. F√≠sico" 
                            type="object" 
                            class="btn-info"
                            invisible="not tenia_documento_fisico"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="display_name"/>
                        </h1>
                    </div>

                    <group string="Informaci√≥n de la Versi√≥n" col="2">
                        <group>
                            <field name="manifiesto_id" readonly="1"/>
                            <field name="version_number" readonly="1"/>
                            <field name="creation_date" readonly="1"/>
                            <field name="created_by" readonly="1"/>
                        </group>
                        <group>
                            <field name="state_at_creation" readonly="1"/>
                            <field name="tenia_documento_fisico" readonly="1"/>
                            <field name="pdf_filename" readonly="1"/>
                            <field name="documento_fisico_filename_original" readonly="1" invisible="not tenia_documento_fisico"/>
                        </group>
                    </group>

                    <group string="Motivo del Cambio" col="1">
                        <field name="change_reason" readonly="1" nolabel="1"/>
                    </group>

                    <group string="Datos de Referencia" col="2">
                        <group>
                            <field name="generador_nombre" readonly="1"/>
                            <field name="transportista_nombre" readonly="1"/>
                        </group>
                        <group>
                            <field name="destinatario_nombre" readonly="1"/>
                            <field name="total_residuos" readonly="1"/>
                        </group>
                    </group>

                    <group string="Archivos de Respaldo" col="2">
                        <group string="PDF/Datos del Sistema">
                            <field name="pdf_file" filename="pdf_filename" readonly="1"/>
                        </group>
                        <group string="Documento F√≠sico Original" invisible="not tenia_documento_fisico">
                            <field name="documento_fisico_original" filename="documento_fisico_filename_original" readonly="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de b√∫squeda para Historial de Versiones -->
    <record id="view_manifiesto_ambiental_version_search" model="ir.ui.view">
        <field name="name">manifiesto.ambiental.version.search</field>
        <field name="model">manifiesto.ambiental.version</field>
        <field name="arch" type="xml">
            <search string="Buscar Versiones">
                <field name="manifiesto_id"/>
                <field name="version_number"/>
                <field name="created_by"/>
                <field name="change_reason"/>
                <field name="generador_nombre"/>
                <field name="transportista_nombre"/>
                <field name="destinatario_nombre"/>
                
                <filter string="Con Documento F√≠sico" name="with_physical_doc" domain="[('tenia_documento_fisico','=',True)]"/>
                <filter string="Sin Documento F√≠sico" name="without_physical_doc" domain="[('tenia_documento_fisico','=',False)]"/>
                <filter string="√öltima Semana" name="last_week" 
                        domain="[('creation_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <filter string="√öltimo Mes" name="last_month" 
                        domain="[('creation_date', '&gt;=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                
                <group expand="0" string="Agrupar por">
                    <filter string="Manifiesto" name="group_manifiesto" context="{'group_by':'manifiesto_id'}"/>
                    <filter string="Creado por" name="group_user" context="{'group_by':'created_by'}"/>
                    <filter string="Fecha de Creaci√≥n" name="group_date" context="{'group_by':'creation_date:month'}"/>
                    <filter string="Estado al Guardar" name="group_state" context="{'group_by':'state_at_creation'}"/>
                    <filter string="Ten√≠a Doc. F√≠sico" name="group_physical" context="{'group_by':'tenia_documento_fisico'}"/>
                </group>
            </search>
        </field>
    </record>
</odoo>